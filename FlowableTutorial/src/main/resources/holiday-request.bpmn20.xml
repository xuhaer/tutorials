<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:xsd="http://www.w3.org/2001/XMLSchema"
  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
  xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC"
  xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI"
  xmlns:flowable="http://flowable.org/bpmn"
  typeLanguage="http://www.w3.org/2001/XMLSchema"
  expressionLanguage="http://www.w3.org/1999/XPath"
  targetNamespace="http://www.flowable.org/processdef">

  <process id="holidayRequest" name="Holiday Request" isExecutable="true">

    <startEvent id="startEvent"/>
    <sequenceFlow sourceRef="startEvent" targetRef="approveTask"/>

    <userTask id="approveTask" name="Approve or reject request" flowable:candidateGroups="managers"/>
    <sequenceFlow sourceRef="approveTask" targetRef="decision"/>

    <exclusiveGateway id="decision"/>
    <sequenceFlow sourceRef="decision" targetRef="externalSystemCall">
      <conditionExpression>
        <![CDATA[
          ${approved}
        ]]>
      </conditionExpression>
    </sequenceFlow>
    <sequenceFlow  sourceRef="decision" targetRef="rejectEnd">
      <conditionExpression>
        <![CDATA[
          ${!approved}
        ]]>
      </conditionExpression>
    </sequenceFlow>

    <serviceTask id="externalSystemCall" name="Enter holidays in external system"
        flowable:class="holidayrequest.CallExternalSystemDelegate"/>
    <sequenceFlow sourceRef="externalSystemCall" targetRef="HttpGet"/>

    <serviceTask id="HttpGet" flowable:type="http">
      <extensionElements>
        <flowable:field name="requestMethod">
          <flowable:string><![CDATA[GET]]></flowable:string>
        </flowable:field>
        <flowable:field name="requestUrl">
          <flowable:expression><![CDATA[http://localhost:8000/polls/1/]]></flowable:expression>
        </flowable:field>
        <flowable:field name="saveResponseParameters">
        	<flowable:string><![CDATA[true]]></flowable:string>
        </flowable:field>
      </extensionElements>
    </serviceTask>
    <sequenceFlow sourceRef="HttpGet" targetRef="HttpGetResult"/>

    <exclusiveGateway id="HttpGetResult"/>
    <sequenceFlow sourceRef="HttpGetResult" targetRef="ShellTask">
      <conditionExpression>
      <!-- 官方文档有误, 非taskId.property -->
        <![CDATA[
          ${HttpGetResponseStatusCode==200}
        ]]>
      </conditionExpression>
    </sequenceFlow>
    <sequenceFlow  sourceRef="HttpGetResult" targetRef="HttpFailEnd">
      <conditionExpression>
        <![CDATA[
          ${HttpGetResponseStatusCode != 200}
        ]]>
      </conditionExpression>
    </sequenceFlow>

    <serviceTask id="ShellTask" flowable:type="shell">
      <extensionElements>
        <flowable:field name="command" stringValue="bash" />
        <!-- 可看到根路径创建了BashTaskDir文件夹 -->
        <flowable:field name="arg1" stringValue="/Users/har/git/JavaTutorial/FlowableTutorial/BashTaskTest.sh"/>
        <flowable:field name="wait" stringValue="true" />
        <flowable:field name="outputVariable" stringValue="resultVar" />
      </extensionElements>
    </serviceTask>
    <sequenceFlow sourceRef="ShellTask" targetRef="approveEnd"/>

    <endEvent id="approveEnd"/>
    <endEvent id="rejectEnd"/>
    <endEvent id="HttpFailEnd"/>

  </process>

</definitions>